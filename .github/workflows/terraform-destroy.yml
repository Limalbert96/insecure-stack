name: Terraform Infrastructure Destroy

# Manual trigger only - requires explicit user action
on:
  workflow_dispatch:
    inputs:
      confirm_destroy:
        description: 'Type "DESTROY" to confirm infrastructure teardown'
        required: true
        type: string
      reason:
        description: 'Reason for destroying infrastructure'
        required: true
        type: string

# Restrict workflow permissions to minimum required
permissions:
  contents: read
  id-token: write  # Required for Workload Identity Federation
  security-events: write

jobs:
  validate-confirmation:
    name: Validate Destroy Confirmation
    runs-on: ubuntu-latest
    outputs:
      confirmed: ${{ steps.check.outputs.confirmed }}

    steps:
      - name: Check confirmation input
        id: check
        run: |
          if [ "${{ github.event.inputs.confirm_destroy }}" != "DESTROY" ]; then
            echo "âŒ Destroy confirmation failed. You must type 'DESTROY' to proceed."
            echo "You entered: '${{ github.event.inputs.confirm_destroy }}'"
            exit 1
          fi
          echo "âœ… Destroy confirmed by user: ${{ github.actor }}"
          echo "Reason: ${{ github.event.inputs.reason }}"
          echo "confirmed=true" >> $GITHUB_OUTPUT

      - name: Log destroy action
        run: |
          echo "## âš ï¸ Infrastructure Destroy Initiated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Reason:** ${{ github.event.inputs.reason }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This action will destroy all Terraform-managed infrastructure." >> $GITHUB_STEP_SUMMARY

  terraform-plan-destroy:
    name: Terraform Plan Destroy
    runs-on: ubuntu-latest
    needs: validate-confirmation
    if: needs.validate-confirmation.outputs.confirmed == 'true'
    outputs:
      tfplan_exitcode: ${{ steps.plan.outputs.exitcode }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/${{ secrets.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-actions/providers/github'
          service_account: 'terraform-ci@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com'

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          install_components: 'gke-gcloud-auth-plugin'

      - name: Terraform Init
        id: init
        run: terraform init
        env:
          TF_VAR_github_pat: ${{ secrets.PAT }}
          TF_VAR_project_id: ${{ secrets.GCP_PROJECT_ID }}
          TF_VAR_region: ${{ secrets.REGION }}
          TF_VAR_github_username: ${{ secrets.USERNAME }}
          TF_VAR_project_number: ${{ secrets.GCP_PROJECT_NUMBER }}

      - name: Terraform Validate
        id: validate
        run: terraform validate

      - name: Terraform Plan Destroy
        id: plan
        run: |
          terraform plan \
            -destroy \
            -var="github_pat=${{ secrets.PAT }}" \
            -var="project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -var="region=${{ secrets.REGION }}" \
            -var="github_username=${{ secrets.USERNAME }}" \
            -var="project_number=${{ secrets.GCP_PROJECT_NUMBER }}" \
            -out=tfplan-destroy \
            -detailed-exitcode || export TF_EXIT=$?
          echo "exitcode=${TF_EXIT:-0}" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Upload Terraform Destroy Plan
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-destroy
          path: tfplan-destroy
          retention-days: 5

      - name: Plan Summary
        run: |
          echo "## Terraform Destroy Plan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Exit Code: ${{ steps.plan.outputs.exitcode }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.plan.outputs.exitcode }}" == "0" ]; then
            echo "â„¹ï¸ No resources to destroy (infrastructure already destroyed or doesn't exist)." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.plan.outputs.exitcode }}" == "2" ]; then
            echo "âš ï¸ **Resources will be destroyed!** Manual approval required to proceed." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The following will be destroyed:" >> $GITHUB_STEP_SUMMARY
            echo "- GKE cluster with all workloads" >> $GITHUB_STEP_SUMMARY
            echo "- MongoDB VM with all data" >> $GITHUB_STEP_SUMMARY
            echo "- VPC network and subnets" >> $GITHUB_STEP_SUMMARY
            echo "- Storage bucket and backups" >> $GITHUB_STEP_SUMMARY
            echo "- Cloud Armor security policy" >> $GITHUB_STEP_SUMMARY
            echo "- All audit logs configuration" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **THIS ACTION CANNOT BE UNDONE**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Terraform plan failed. Check logs for details." >> $GITHUB_STEP_SUMMARY
          fi

  terraform-destroy:
    name: Terraform Destroy (Manual Approval Required)
    runs-on: ubuntu-latest
    needs: terraform-plan-destroy
    if: |
      needs.terraform-plan-destroy.outputs.tfplan_exitcode == '2' &&
      github.event.inputs.confirm_destroy == 'DESTROY'
    environment:
      name: production
      url: https://console.cloud.google.com/compute/instances?project=${{ secrets.GCP_PROJECT_ID }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/${{ secrets.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-actions/providers/github'
          service_account: 'terraform-ci@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com'

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          install_components: 'gke-gcloud-auth-plugin'

      - name: Download Terraform Destroy Plan
        uses: actions/download-artifact@v4
        with:
          name: tfplan-destroy

      - name: Terraform Init
        run: terraform init
        env:
          TF_VAR_github_pat: ${{ secrets.PAT }}
          TF_VAR_project_id: ${{ secrets.GCP_PROJECT_ID }}
          TF_VAR_region: ${{ secrets.REGION }}
          TF_VAR_github_username: ${{ secrets.USERNAME }}
          TF_VAR_project_number: ${{ secrets.GCP_PROJECT_NUMBER }}

      - name: Terraform Destroy
        id: destroy
        run: |
          echo "ðŸ”¥ Starting infrastructure destruction..."
          echo "Triggered by: ${{ github.actor }}"
          echo "Reason: ${{ github.event.inputs.reason }}"
          echo ""

          terraform apply -auto-approve tfplan-destroy

      - name: Verify Destruction
        id: verify
        run: |
          echo "## ðŸ”¥ Infrastructure Destroyed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Destroyed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Reason:** ${{ github.event.inputs.reason }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if resources still exist
          echo "### Verification:" >> $GITHUB_STEP_SUMMARY

          # Check GKE clusters
          CLUSTERS=$(gcloud container clusters list --format="value(name)" 2>/dev/null | wc -l)
          echo "- GKE Clusters remaining: ${CLUSTERS}" >> $GITHUB_STEP_SUMMARY

          # Check compute instances
          INSTANCES=$(gcloud compute instances list --format="value(name)" 2>/dev/null | wc -l)
          echo "- Compute Instances remaining: ${INSTANCES}" >> $GITHUB_STEP_SUMMARY

          # Check storage buckets (only tasky-mongo-backup)
          BUCKETS=$(gcloud storage buckets list --format="value(name)" 2>/dev/null | grep -c "tasky-mongo-backup" || echo "0")
          echo "- Tasky Backup Buckets remaining: ${BUCKETS}" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${CLUSTERS}" == "0" ] && [ "${INSTANCES}" == "0" ] && [ "${BUCKETS}" == "0" ]; then
            echo "âœ… All infrastructure successfully destroyed." >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Some resources may still exist. Check GCP console for manual cleanup." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Destroy Summary
        if: always()
        run: |
          if [ "${{ steps.destroy.outcome }}" == "success" ]; then
            echo "âœ… Terraform destroy completed successfully!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Verify all resources are gone in GCP Console" >> $GITHUB_STEP_SUMMARY
            echo "2. Check for any orphaned resources (load balancers, IPs, etc.)" >> $GITHUB_STEP_SUMMARY
            echo "3. Review audit logs for destruction timeline" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Terraform destroy failed. Check logs for details." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Troubleshooting:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Some resources may have dependencies preventing deletion" >> $GITHUB_STEP_SUMMARY
            echo "2. Check GCP Console for resources in 'deleting' state" >> $GITHUB_STEP_SUMMARY
            echo "3. You may need to manually delete stuck resources" >> $GITHUB_STEP_SUMMARY
            echo "4. Run the destroy workflow again after manual cleanup" >> $GITHUB_STEP_SUMMARY
          fi

  no-resources-to-destroy:
    name: No Resources to Destroy
    runs-on: ubuntu-latest
    needs: terraform-plan-destroy
    if: needs.terraform-plan-destroy.outputs.tfplan_exitcode == '0'

    steps:
      - name: Nothing to Destroy
        run: |
          echo "## â„¹ï¸ No Infrastructure to Destroy" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Terraform reports no resources exist to destroy." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This could mean:" >> $GITHUB_STEP_SUMMARY
          echo "1. Infrastructure was already destroyed" >> $GITHUB_STEP_SUMMARY
          echo "2. Infrastructure was never deployed via Terraform" >> $GITHUB_STEP_SUMMARY
          echo "3. Terraform state is empty or out of sync" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check GCP Console to verify no orphaned resources exist." >> $GITHUB_STEP_SUMMARY
